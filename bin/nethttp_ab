#!/usr/bin/env ruby
require 'rubygems'
require File.dirname(File.expand_path(__FILE__)) + '/../lib/requester.rb'

# SIMPLE USAGE:
# 3 concurrent threads and 100 total requests
# nethttp_ab -n100 -c3 http://www.yoursite.com
#
# OR simulate one user and follow all local links on the page
# nethttp_ab -f http://localhost:3000
#
# simulate 3 users (all local links on the page will be visited once)
# nethttp_ab --follow_links -c3 http://localhost:3000

opts = {}

if ARGV.include?('--follow_links') || ARGV.include?('-f')
  opts[:follow_links] = true
else
  opts[:follow_links] = false
end

if ARGV.join.match(/-c\s*(\d*)/)
  opts[:concurrent_threads] = $1.to_i
else
  opts[:concurrent_threads] = 1
end

if ARGV.join.match(/-n\s*(\d*)/)
  opts[:requests] = $1.to_i
else
  opts[:requests] = 10
end

url_to_benchmark = "http://localhost:3000/"

# search in ARGV for the url to perform benchmarking on
ARGV.each do |arg|
  url_to_benchmark = arg if arg =~ NethttpAb::Requester::URL_REGEXP
end

url_to_benchmark = "http://" + url_to_benchmark if url_to_benchmark !~ /^https?:\/\//

requester = NethttpAb::Requester.new
requester.concurrent_users  = opts[:concurrent_threads]
requester.num_of_requests   = opts[:requests]
requester.follow_links      = opts[:follow_links]
requester.url               = url_to_benchmark

requester.proceed
requester.print_stats
